import customtkinter as ctk
from PIL import Image, ImageTk
import datetime, csv, os, threading, sys
from playsound import playsound

# --------------------------
# CONFIGURATION
CSV_FILE = "meknes_prayer_times_2025.csv"
BACKGROUND_FILE = "background.jpg"
ADHAN_FILE = "adhan.wav"
IQAMA_FILE = "iqama.wav"  # Ù…Ù„Ù Ø¥Ù‚Ø§Ù…Ø© Ø§Ù„ØµÙ„Ø§Ø©
CITY = "Meknes"
COUNTRY = "Morocco"
REFRESH_INTERVAL_MS = 1000

# Buttons images
CLOSE_IMG = "close.png"
MINIMIZE_IMG = "minimize.png"

# Arabic labels
DISPLAY_NAMES = {
    "Fajr": "Ø§Ù„ÙØ¬Ø±",
    "Dhuhr": "Ø§Ù„Ø¸Ù‡Ø±", 
    "Asr": "Ø§Ù„Ø¹ØµØ±",
    "Maghrib": "Ø§Ù„Ù…ØºØ±Ø¨",
    "Isha": "Ø§Ù„Ø¹Ø´Ø§Ø¡"
}

MOSQUE_NAME = "Ù…Ø³Ø¬Ø¯ Ø±ÙŠØ§Ù†"
PLACE_NAME = "Ù…Ø¯ÙŠÙ†Ø© Ù…ÙƒÙ†Ø§Ø³ - Ø§Ù„Ù…ØºØ±Ø¨"

# ÙˆÙ‚Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø°Ø§Ù† (Ø¯Ù‚Ø§Ø¦Ù‚) - Ø£ÙˆÙ‚Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ù„ÙƒÙ„ ØµÙ„Ø§Ø©
IQAMA_DELAY = {
    "Fajr": 20,
    "Dhuhr": 15,
    "Asr": 15,
    "Maghrib": 8,
    "Isha": 15
}

# --------------------------
# CustomTkinter Settings
ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("blue")

def resource_path(relative_path):
    try:
        base_path = sys._MEIPASS
    except Exception:
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)

def load_csv(file_path=CSV_FILE):
    data = {}
    place = PLACE_NAME
    if not os.path.exists(file_path):
        return data, place
    with open(file_path,newline="",encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            date = row.get("ØªØ§Ø±ÙŠØ®") or row.get("date")
            if date:
                data[date] = {
                    "Fajr": row.get("Ø§Ù„ÙØ¬Ø±",""),
                    "Dhuhr": row.get("Ø§Ù„Ø¸Ù‡Ø±",""),
                    "Asr": row.get("Ø§Ù„Ø¹ØµØ±",""),
                    "Maghrib": row.get("Ø§Ù„Ù…ØºØ±Ø¨",""),
                    "Isha": row.get("Ø§Ù„Ø¹Ø´Ø§Ø¡","")
                }
            if "place" in row and row["place"]:
                place = row["place"]
    return data, place

# --------------------------
class MosqueApp:
    def __init__(self, root):
        self.root = root
        self.root.title(MOSQUE_NAME)
        self.root.attributes("-fullscreen", True)
        self.root.bind("<Escape>", lambda e: self.toggle_fullscreen())
        self.root.bind("<F1>", lambda e: self.test_adhan_maghrib())  # Test Adhan F1

        screen_w = root.winfo_screenwidth()
        screen_h = root.winfo_screenheight()

        # Background - Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„ Ø§Ù„ØµÙˆØ±Ø©
        bg_file = resource_path(BACKGROUND_FILE)
        if os.path.exists(bg_file):
            try:
                bg_img = Image.open(bg_file)
                # Ø§Ø³ØªØ®Ø¯Ø§Ù… CTkImage Ù„Ù„Ø®Ù„ÙÙŠØ©
                self.bg_image = ctk.CTkImage(
                    light_image=bg_img,
                    dark_image=bg_img,
                    size=(screen_w, screen_h)
                )
                self.bg_label = ctk.CTkLabel(root, image=self.bg_image, text="")
                self.bg_label.place(x=0, y=0, relwidth=1, relheight=1)
            except Exception as e:
                print(f"Error loading background: {e}")
                # Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ù…Ø´ÙƒÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡
                self.bg_label = ctk.CTkLabel(root, text="", fg_color="black")
                self.bg_label.place(x=0, y=0, relwidth=1, relheight=1)
        else:
            print(f"Background file not found: {bg_file}")
            self.bg_label = ctk.CTkLabel(root, text="", fg_color="black")
            self.bg_label.place(x=0, y=0, relwidth=1, relheight=1)

        # Main container with transparent background
        main_container = ctk.CTkFrame(root, fg_color="transparent")
        main_container.pack(fill="both", expand=True)

        # Top buttons - Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
        btn_frame = ctk.CTkFrame(main_container, fg_color="transparent", height=60)
        btn_frame.pack(side="top", fill="x", padx=20, pady=10)
        btn_frame.pack_propagate(False)

        # Close and minimize buttons - Ø§Ø³ØªØ®Ø¯Ø§Ù… CTkImage Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
        button_container = ctk.CTkFrame(btn_frame, fg_color="transparent")
        button_container.pack(side="right")

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¹ ØµÙˆØ±Ø©
        close_img_path = resource_path(CLOSE_IMG)
        if os.path.exists(close_img_path):
            try:
                close_img = Image.open(close_img_path)
                self.close_icon = ctk.CTkImage(
                    light_image=close_img,
                    dark_image=close_img,
                    size=(20, 20)
                )
                close_btn = ctk.CTkButton(
                    button_container,
                    image=self.close_icon,
                    text="",  # Ù†Øµ ÙØ§Ø±Øº
                    width=30,
                    height=30,
                    fg_color="#E74C3C",
                    hover_color="#C0392B",
                    command=root.destroy
                )
            except Exception as e:
                print(f"Error loading close icon: {e}")
                close_btn = ctk.CTkButton(
                    button_container,
                    text="âœ•",
                    width=30,
                    height=30,
                    fg_color="#E74C3C",
                    hover_color="#C0392B",
                    font=("Arial", 20, "bold"),
                    command=root.destroy
                )
        else:
            print(f"Close icon not found: {close_img_path}")
            close_btn = ctk.CTkButton(
                button_container,
                text="âœ•",
                width=30,
                height=30,
                fg_color="#E74C3C",
                hover_color="#C0392B",
                font=("Arial", 20, "bold"),
                command=root.destroy
            )
        
        close_btn.pack(side="right", padx=5)

        # Ø²Ø± Ø§Ù„ØªØµØºÙŠØ± Ù…Ø¹ ØµÙˆØ±Ø©
        minimize_img_path = resource_path(MINIMIZE_IMG)
        if os.path.exists(minimize_img_path):
            try:
                minimize_img = Image.open(minimize_img_path)
                self.minimize_icon = ctk.CTkImage(
                    light_image=minimize_img,
                    dark_image=minimize_img,
                    size=(20, 20)
                )
                min_btn = ctk.CTkButton(
                    button_container,
                    image=self.minimize_icon,
                    text="",  # Ù†Øµ ÙØ§Ø±Øº
                    width=30,
                    height=30,
                    fg_color="#3498DB",
                    hover_color="#2980B9",
                    command=root.iconify
                )
            except Exception as e:
                print(f"Error loading minimize icon: {e}")
                min_btn = ctk.CTkButton(
                    button_container,
                    text="â”€",
                    width=30,
                    height=30,
                    fg_color="#3498DB",
                    hover_color="#2980B9",
                    font=("Arial", 20, "bold"),
                    command=root.iconify
                )
        else:
            print(f"Minimize icon not found: {minimize_img_path}")
            min_btn = ctk.CTkButton(
                button_container,
                text="â”€",
                width=30,
                height=30,
                fg_color="#3498DB",
                hover_color="#2980B9",
                font=("Arial", 20, "bold"),
                command=root.iconify
            )
        
        min_btn.pack(side="right", padx=5)

        # Mosque & place labels
        self.mosque_label = ctk.CTkLabel(
            main_container,
            text=MOSQUE_NAME,
            font=("Arial", 48, "bold"),
            text_color="gold",
            fg_color="transparent"
        )
        self.mosque_label.pack(pady=(20, 5))

        self.place_label = ctk.CTkLabel(
            main_container,
            text=PLACE_NAME,
            font=("Arial", 32),
            text_color="white",
            fg_color="transparent"
        )
        self.place_label.pack(pady=(0, 10))

        # Date & Day
        self.date_label = ctk.CTkLabel(
            main_container,
            text="",
            font=("Arial", 24),
            text_color="white",
            fg_color="transparent"
        )
        self.date_label.pack(pady=(0, 20))

        # Next prayer section
        next_prayer_frame = ctk.CTkFrame(
            main_container,
            fg_color="#1a1a1a",
            corner_radius=20,
            width=600,
            height=200
        )
        next_prayer_frame.pack(pady=20)
        next_prayer_frame.pack_propagate(False)

        next_prayer_container = ctk.CTkFrame(next_prayer_frame, fg_color="transparent")
        next_prayer_container.pack(expand=True)

        self.next_title = ctk.CTkLabel(
            next_prayer_container,
            text="â° : Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© ",
            font=("Arial", 32),
            text_color="yellow"
        )
        self.next_title.pack(pady=(20, 5))

        self.next_name = ctk.CTkLabel(
            next_prayer_container,
            text="",
            font=("Arial", 42, "bold"),
            text_color="white"
        )
        self.next_name.pack(pady=5)

        self.countdown = ctk.CTkLabel(
            next_prayer_container,
            text="",
            font=("Arial", 28),
            text_color="#00FFFF"
        )
        self.countdown.pack(pady=(5, 20))

        # Schedule - MODERN COLUMNS DESIGN
        schedule_frame = ctk.CTkFrame(
            main_container,
            fg_color="#2d2d2d",
            corner_radius=25,
            height=180
        )
        schedule_frame.pack(side="bottom", pady=30, padx=50, fill="x")
        schedule_frame.pack_propagate(False)

        # Title
        schedule_title = ctk.CTkLabel(
            schedule_frame,
            text="ğŸ•Œ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ÙŠÙˆÙ…",
            font=("Arial", 32, "bold"),
            text_color="white"
        )
        schedule_title.pack(pady=15)

        # Prayer times in modern columns - ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
        columns_container = ctk.CTkFrame(schedule_frame, fg_color="transparent")
        columns_container.pack(pady=10)

        self.prayer_columns = []
        prayers = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"]

        for i, prayer in enumerate(prayers):
            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø¹Ø§ÙƒØ³ (Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±)
            reverse_i = len(prayers) - 1 - i
            
            column_frame = ctk.CTkFrame(
                columns_container,
                width=140,
                height=110,
                fg_color="#3a3a3a",
                corner_radius=15,
                border_width=2,
                border_color="#555555"
            )
            column_frame.grid(row=0, column=reverse_i, padx=12, pady=5)  # Ø§Ø³ØªØ®Ø¯Ø§Ù… reverse_i Ù‡Ù†Ø§
            column_frame.grid_propagate(False)
            column_frame.pack_propagate(False)
            
            # Prayer name
            name_label = ctk.CTkLabel(
                column_frame,
                text=DISPLAY_NAMES[prayer],
                font=("Arial", 20, "bold"),
                text_color="gold"
            )
            name_label.pack(pady=(15, 5))
            
            # Prayer time
            time_label = ctk.CTkLabel(
                column_frame,
                text="--:--",
                font=("Arial", 24, "bold"),
                text_color="white"
            )
            time_label.pack(pady=(5, 15))
            
            self.prayer_columns.append((prayer, time_label))

        # Overlay Adhan + Iqama
        self.overlay = ctk.CTkFrame(root, fg_color="black")
        self.overlay.place(relwidth=1, relheight=1)
        
        overlay_container = ctk.CTkFrame(self.overlay, fg_color="transparent")
        overlay_container.pack(expand=True)
        
        # Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…ØªØ­Ø±ÙƒØ© Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©
        self.iqama_icon = ctk.CTkLabel(
            overlay_container,
            text="ğŸ•Œ",
            font=("Arial", 120, "bold"),  # Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±
            text_color="gold"
        )
        self.iqama_icon.pack(pady=20)
        
        self.overlay_label = ctk.CTkLabel(
            overlay_container,
            text="",
            font=("Arial", 64, "bold"),  # Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±
            text_color="gold"
        )
        self.overlay_label.pack(pady=10)
        
        self.overlay_countdown = ctk.CTkLabel(
            overlay_container,
            text="",
            font=("Arial", 72, "bold"),  # Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± Ù„Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            text_color="#00FFFF"
        )
        self.overlay_countdown.pack(pady=10)
        
        self.overlay.lower()

        # Load CSV
        self.data, self.place = load_csv()
        self.current_date = datetime.date.today()
        self.last_adhan_played = None
        self.last_iqama_played = None
        self.iqama_scheduled = False
        self.current_prayer_for_iqama = None
        self.iqama_countdown_time = 0
        self.animation_running = False

        self.update_display()
        self.root.after(REFRESH_INTERVAL_MS, self.tick)

    # --------------------------
    def toggle_fullscreen(self):
        self.root.attributes("-fullscreen", not self.root.attributes("-fullscreen"))

    def find_next_prayer(self):
        dstr = self.current_date.strftime("%Y-%m-%d")
        day = self.data.get(dstr)
        if not day: return None,None
        now = datetime.datetime.now()
        base = datetime.datetime.combine(self.current_date,datetime.time(0,0))
        for key in ["Fajr","Dhuhr","Asr","Maghrib","Isha"]:
            t = day.get(key)
            if not t: continue
            h,m = map(int,t.split(":"))
            dt = base + datetime.timedelta(hours=h,minutes=m)
            if dt > now: return key, dt
        return None,None

    def play_adhan(self):
        adhan_file = resource_path(ADHAN_FILE)
        if os.path.exists(adhan_file):
            threading.Thread(target=lambda: playsound(adhan_file, block=True), daemon=True).start()

    def play_iqama(self):
        iqama_file = resource_path(IQAMA_FILE)
        if os.path.exists(iqama_file):
            threading.Thread(target=lambda: playsound(iqama_file, block=True), daemon=True).start()

    def test_adhan_maghrib(self):
        """Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø°Ø§Ù† Ù„Ù„Ù…ØºØ±Ø¨"""
        self.start_adhan_overlay("Maghrib")

  
    # --------------------------
    def start_adhan_overlay(self, prayer_name):
        """Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø°Ø§Ù†"""
        print(f"ğŸ”” Ø¨Ø¯Ø£ Ø§Ù„Ø£Ø°Ø§Ù† Ù„ØµÙ„Ø§Ø© {prayer_name}")
        self.overlay_label.configure(text=f"ğŸ•Œ Ø£Ø°Ø§Ù† {DISPLAY_NAMES[prayer_name]} ")
        self.iqama_icon.configure(text="ğŸ””", font=("Arial", 120, "bold"))
        self.overlay_countdown.configure(text="")
        self.overlay.lift()
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†
        self.play_adhan()
        
        # Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©
        self.current_prayer_for_iqama = prayer_name
        
        # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø©
        iqama_delay_minutes = IQAMA_DELAY.get(prayer_name, 1)
        print(f"â° Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø¨Ø¹Ø¯ {iqama_delay_minutes} Ø¯Ù‚Ø§Ø¦Ù‚")
        
        # Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø°Ø§Ù† Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ¨Ø¯Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©
        self.root.after(60 * 1000, lambda: self.start_iqama_countdown(prayer_name, iqama_delay_minutes))

    # --------------------------
    def start_iqama_countdown(self, prayer_name, total_minutes):
        """Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©"""
        print(f"ğŸƒ Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©: {total_minutes} Ø¯Ù‚Ø§Ø¦Ù‚")

        self.current_prayer_for_iqama = prayer_name
        self.iqama_countdown_time = total_minutes * 60  # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø«ÙˆØ§Ù†ÙŠ

        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        self.overlay.lift()
        for widget in self.overlay.winfo_children():
            widget.destroy()

        # ğŸ”¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© ÙÙŠ Ø§Ù„ÙˆØ³Ø·
        self.iqama_icon = ctk.CTkLabel(
            self.overlay,
            text="ğŸ•Œ",
            font=("Arial", 120, "bold"),
            text_color="gold"
        )
        self.iqama_icon.place(relx=0.5, rely=0.35, anchor="center")  # ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø´ÙˆÙŠØ©

        # ğŸ”¹ Frame Ø®Ø§Øµ Ø¨Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ ØªØ­Øª Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ù…Ø³Ø§ÙØ© ÙƒØ¨ÙŠØ±Ø©
        text_frame = ctk.CTkFrame(self.overlay, fg_color="black")
        text_frame.place(relx=0.5, rely=0.7, anchor="center")  # Ø£Ø³ÙÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ù…Ø³Ø§ÙØ©

        # Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ø¨Øª
        self.iqama_text = ctk.CTkLabel(
            text_frame,
            text=f"ğŸƒ Ø¥Ù‚Ø§Ù…Ø© ØµÙ„Ø§Ø© {DISPLAY_NAMES[prayer_name]}",
            font=("Arial", 42, "bold"),
            text_color="white"
        )
        self.iqama_text.pack(pady=(0, 15))

        # Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±
        self.overlay_countdown = ctk.CTkLabel(
            text_frame,
            text="",
            font=("Arial", 72, "bold"),
            text_color="#00FFFF"
        )
        self.overlay_countdown.pack()

        # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø±ÙŠÙƒ ÙˆØ§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        self.animation_running = True
        self.animate_iqama_icon()
        self.update_iqama_countdown()


    # --------------------------
    def animate_iqama_icon(self, size=120, growing=True):
        """ØªØ­Ø±ÙŠÙƒ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© ÙÙ‚Ø· (ØªÙƒØ¨ÙŠØ± ÙˆØªØµØºÙŠØ± Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙˆØµ)"""
        if not self.animation_running:
            return

        if growing:
            size += 8
            if size >= 150:
                growing = False
        else:
            size -= 8
            if size <= 100:
                growing = True

        if hasattr(self, "iqama_icon") and self.iqama_icon.winfo_exists():
            self.iqama_icon.configure(font=("Arial", size, "bold"))

        if self.overlay.winfo_ismapped() and self.animation_running:
            self.root.after(200, lambda: self.animate_iqama_icon(size, growing))

  
    # --------------------------
    def start_animation(self):
        """Ø¨Ø¯Ø¡ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©"""
        self.animation_running = True
        self.animate_iqama_icon()

    # --------------------------
    def stop_animation(self):
        """Ø¥ÙŠÙ‚Ø§Ù ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©"""
        self.animation_running = False
        if hasattr(self, "iqama_icon") and self.iqama_icon.winfo_exists():
            self.iqama_icon.configure(font=("Arial", 120, "bold"))

    # --------------------------
    def play_iqama_sound(self):
        """ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ"""
        if self.current_prayer_for_iqama:
            print(f"ğŸ”Š ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ù„ØµÙ„Ø§Ø© {self.current_prayer_for_iqama}")
            
            self.stop_animation()
            self.play_iqama()
            
            self.overlay_countdown.configure(text="ğŸ•Œ Ø¥Ø·ÙØ¦ Ø§Ù„Ù‡Ø§ØªÙ")
            
            self.root.after(60 * 1000, self.hide_overlay)
            self.iqama_scheduled = False
            self.current_prayer_for_iqama = None

    # --------------------------
    def update_iqama_countdown(self):
        """ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©"""
        if self.iqama_countdown_time > 0:
            minutes = self.iqama_countdown_time // 60
            seconds = self.iqama_countdown_time % 60
            
            # Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ±
            self.overlay_countdown.configure(text=f"{minutes:02d}:{seconds:02d}")
            
            self.iqama_countdown_time -= 1
            self.root.after(1000, self.update_iqama_countdown)
        else:
            # Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠØŒ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©
            self.play_iqama_sound()

   
    # --------------------------
    def hide_overlay(self):
        """Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ overlay"""
        self.overlay.lower()
        self.stop_animation()

    # --------------------------
    def update_next_prayer(self):
        key, dt = self.find_next_prayer()
        if key and dt:
            self.next_name.configure(text=DISPLAY_NAMES[key])
            remaining = dt - datetime.datetime.now()
            total = int(remaining.total_seconds())
            if total < 0: total = 0
            h = total//3600
            m = (total%3600)//60
            s = total%60
            
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù‚ÙŠ Ø£Ù‚Ù„ Ù…Ù† Ø³Ø§Ø¹Ø©ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø«ÙˆØ§Ù†ÙŠ ÙÙ‚Ø·
            if h > 0:
                self.countdown.configure(text=f"Ø¨Ø§Ù‚ÙŠ : {h:02d}:{m:02d}:{s:02d}")
            else:
                self.countdown.configure(text=f"Ø¨Ø§Ù‚ÙŠ : {m:02d}:{s:02d}")

            if total <= 1 and self.last_adhan_played != key:
                self.last_adhan_played = key
                self.start_adhan_overlay(key)
        else:
            self.next_name.configure(text="--")
            self.countdown.configure(text="")

    # --------------------------
    def update_display(self):
        now = datetime.datetime.now()
        weekday_ar = ["Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯"]
        self.date_label.configure(text=f"{weekday_ar[now.weekday()]}ØŒ {now.day} / {now.month} / {now.year} - {now.strftime('%H:%M:%S')}")
        dstr = self.current_date.strftime("%Y-%m-%d")
        day = self.data.get(dstr)
        if day:
            for prayer, time_label in self.prayer_columns:
                time_label.configure(text=day.get(prayer,"--:--"))
        self.update_next_prayer()

    def tick(self):
        self.update_display()
        self.root.after(REFRESH_INTERVAL_MS, self.tick)

# --------------------------
if __name__=="__main__":
    root = ctk.CTk()
    app = MosqueApp(root)
    root.mainloop()